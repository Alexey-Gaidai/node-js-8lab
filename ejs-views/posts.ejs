<!DOCTYPE html>
<html lang="en">
<%- include('./partials/head.ejs') %>

  <body>
    <%- include('./partials/nav.ejs') %>
      <h1 class="list_stat">Список статей:</h1>
      <div class="search_wrapper">
        <div class="d1">

          <form id="posts-search" class="search_form" method="get" action="/posts">
            <input type="text" id="search_id" name="find" placeholder="Искать здесь...">
            <button>
              <i class="fa fa-search ">
              </i>
            </button>
          </form>

        </div>
        <div class="dropdown dropdown-dark">
          <form id="posts-author" action="/posts" method="get">
            <div class="container_search_form">
              <select name="author" class="dropdown-select">
                <option value="">Выбрать автора</option>
                <% posts.forEach(({ id, title, createdAt, text, author, review }) => { %>
                <option value=<%= author %>><%= author %></option>
                <% }) %>
              </select>
              <button class="button_author_search">
                <i class="fa fa-search">
                </i>
            </button action="/posts">
          </div>
          </form>


          </div>
          <form  style="margin-left: 1em;" action="/posts" method="get" id="posts-date">
            <div style="    display: flex;
            align-items: center;" class="search_date__block">
              <label style="padding: 0px 5px 0px 0px;" for="start">Начало:</label>
              <input type="date" id="start" name="start" value="2022-05-05" >
              <label style="padding: 0px 5px 0px 5px;" for="start">Конец:</label>
              <input type="date" id="end" name="end" value="2022-05-06" >
              <button class="button_author_search">
                <i class="fa fa-search">
                </i>
            </button action="/posts" >
            </div>
          </form>
      </div>
    </div>
      <ul>
        <% if (posts.length) { %>
          <% posts.forEach(({ id, title, createdAt, text, author, review, tag }) => { %>
            <li class="review-item__main ">
              <article>
                <div class="wrapper__trash ">
                <button class="btn-delete " data-id="<%=id %>">
              <i class="fas fa-trash-alt" data-id="<%= id %>"></i>
              </button>
            </div>
            <h2>
              <a href="/posts/<%= id %>">
                <%= title %>
              </a>
            </h2>
            <div class="container_text">
              <p class ="text_article_vnesh">
                <%= text %>
              </p>
            </div>
            <div class="info">
              <span><span style="color: rgb(129, 211, 217);">Автор:</span>
              <%= author %>
                </span>
            </div>
            <div class="rating_div"><span style="color: rgb(129, 211, 217);">Рейтинг: </span>
              <span>
                    <% 
                    getAvgMark = function(review){
                      if (review.length == 0){
                        return 0;
                      }
                      else{
                        sum = 0;
                        for (var i = 0; i < review.length; i++){
                          sum += review[i].mark;
                        }
                        return sum/review.length;
                      }
                    }
                    %>
                    <%= getAvgMark(review).toFixed(1) %>
                  </span></div>
            <div class="tag_div"> <span><span style="color: rgb(129, 211, 217);">Тег: </span>
              <%= tag %>
                </span>
            </div>
            <p style="text-align: end;    padding: 0;
          margin: 0;">
              <%= createdAt.toLocaleDateString() %>
            </p>
            </article>
            </li>
            <% }) %>
              <% } %>
                </ul>
                <script>
                </script>
                <script>
                  document.addEventListener('click', (e) => {
                    const id = e.target ?.dataset ?.id || null;
                    if (id) {
                      fetch(`/posts/${id}`, {
                        method: 'DELETE',
                      }).then(() => {
                        window.location.reload();
                      });
                    }
                  });
                </script>
  </body>

</html>